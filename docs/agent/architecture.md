# 项目架构

## 目录结构

```
app/                      # Next.js 页面和 API Routes
├── (auth)/               # 认证页面（login, register）
├── api/                  # API 端点（34 个路由）
│   ├── jobs/             # 任务管理
│   ├── api-keys/         # API 密钥
│   ├── styles/           # 风格管理
│   ├── auth/             # 鉴权系统
│   ├── configs/          # 系统配置
│   ├── gemini/           # Gemini 测试
│   ├── tts/              # TTS 语音合成
│   └── ...
├── jobs/                 # 任务列表和详情页面
├── settings/             # 系统设置页面
├── styles/               # 风格管理页面
├── guide/                # 使用教程页面
└── license-error/        # 授权错误页面

lib/                      # 核心业务逻辑
├── db/                   # 数据库三层架构
│   ├── core/             # 核心表操作（jobs, api-keys, configs, users）
│   ├── tables/           # 业务表操作（8 个文件）
│   └── managers/         # 高层管理器（state-manager, runtime-data-loader）
├── workflow/             # 工作流引擎
│   ├── engine.ts         # 工作流主引擎（核心文件）
│   ├── step-definitions.ts # 步骤定义
│   ├── style-loader.ts   # 风格加载器
│   ├── state/            # 状态管理模块
│   └── steps/            # 步骤实现（五阶段）
│       ├── analysis/     # 阶段1：视频分析
│       ├── narration/    # 阶段2：旁白生成
│       ├── extract/      # 阶段3：分镜提取
│       ├── process/      # 阶段4：音画同步
│       └── compose/      # 阶段5：最终合成
├── ai/                   # AI 客户端
│   ├── gemini/           # Gemini AI（Vertex AI / AI Studio）
│   └── tts/              # TTS 语音合成
│       ├── fish-audio-provider.ts  # Fish Audio（付费高质量）
│       └── edge-tts-provider.ts    # Edge TTS（免费）
├── media/                # 本地 FFmpeg 服务
│   ├── ffmpeg-service.ts # 核心服务实现
│   ├── operations/       # 操作实现（9 个：split, concat, merge, speed, metadata, subtitle, mix-bgm, loop, trim-jumpcuts）
│   ├── utils/            # 工具函数
│   │   ├── exec.ts       # 命令执行封装
│   │   ├── temp-manager.ts # 临时文件管理
│   │   └── timeout-calculator.ts # 动态超时计算
│   └── types.ts          # 类型定义
├── utils/                # 工具函数（logger, retry, template-engine）
├── auth/                 # 鉴权相关
├── storage/              # 存储模块
│   ├── gcs-client.ts     # GCS 客户端
│   ├── tracking.ts       # 存储追踪
│   └── cleaner.ts        # 存储清理（light/deep/by_age 模式）
├── subtitle/             # 字幕系统（ASS 格式）
│   ├── generator.ts      # 字幕生成器
│   ├── text-wrapper.ts   # 智能换行
│   └── adaptive-size.ts  # 自适应字体大小
└── exporters/            # 导出工具

components/               # React 组件
├── ui/                   # UI 组件库（三分类架构）
│   ├── base/             # 基础原子组件（button, input, badge...）
│   ├── composite/        # 复合组件（card, dialog, tabs...）
│   └── feedback/         # 反馈组件（accordion, pagination...）
├── jobs/                 # 任务相关组件
├── settings/             # 设置组件
├── workbench/            # 工作台组件
├── styles/               # 风格管理组件
├── task-creation/        # 任务创建组件
├── dialogs/              # 对话框组件
├── guide/                # 教程组件
└── layout/               # 布局组件

styles/                   # 风格预设（20 个 YAML 文件）
├── style-1000.yaml ~ style-1019.yaml
└── _templates/           # 系统模板

types/                    # TypeScript 类型定义（6 个子目录）
├── ai/                   # AI 服务类型（gemini, tts, clients）
├── api/                  # API 类型（api-key, config, storage）
├── core/                 # 核心类型（job, style, scene-id, workbench）
├── db/                   # 数据库类型（row-types, structured-data）
├── utils/                # 工具类型（logger）
├── workflow/             # 工作流类型（context）
└── index.ts              # 类型导出入口
scripts/                  # 运维脚本
```

## API 路由分类（34 个路由文件）

**任务管理**（8 个）：
- CRUD：GET/POST `/api/jobs`、GET/DELETE `/api/jobs/:id`
- 数据：GET `logs`、GET `cost`、GET `download`
- 验证：POST `validate`

> 注：任务控制功能（stop）已在 v12.1.0 移除，任务失败需创建新任务重试

**API 密钥**（6 个）：GET/POST `/api/api-keys`、GET/PUT/DELETE `/api/api-keys/:service`、POST `/api/api-keys/verify`

**风格管理**（8 个）：GET/POST `/api/styles`、GET/PUT/DELETE `/api/styles/:id`、POST `/api/styles/preview`、POST `/api/styles/full-preview`、GET `/api/styles/templates/:name`

**鉴权系统**（7 个）：POST login/logout/register、GET status、GET/POST tokens、DELETE tokens/:id

**系统配置**（5 个）：GET/POST `/api/configs`、GET/PUT/DELETE `/api/configs/:key`

**服务测试**（3 个）：POST Gemini 测试/模型列表、POST GCS 测试

**存储管理**（2 个）：GET `/api/storage/stats`、POST `/api/storage/cleanup`

**TTS 语音合成**（3 个）：GET `/api/tts/voices`、GET `/api/tts/status`、POST `/api/tts/verify-voice`

**其他**（4 个）：GET 健康检查、GET/POST 初始化、POST 视频上传、POST 清空缓存

## 数据库表概览（15 个）

**核心业务表**：`jobs`、`api_keys`、`configs`

**鉴权系统表**：`users`、`api_tokens`（简化版）、`api_access_tokens`（用户关联版）

**任务状态表**：`job_current_state`、`job_step_history`、`job_logs`

**视频分镜表**：`job_videos`、`job_scenes`

**外部服务表**：`scene_audio_candidates`、`api_calls`

**系统管理表**：`schema_version`、`distributed_locks`

> 注：`nca_jobs` 表已在 v12.1.0 废弃并删除

详细定义见 [database.md](database.md)

## 核心模块说明

### 工作流引擎

核心文件：`lib/workflow/engine.ts`

工作流五阶段流水线，详见 [workflow.md](workflow.md)

### AI 客户端

双平台架构：
- **Vertex AI**：企业级
- **AI Studio**：个人用户，限制 300MB/1 小时

### 数据库三层架构

1. **core/**：核心表操作（直接 SQL）
2. **tables/**：业务表操作（带业务逻辑）
3. **managers/**：高层管理器（跨表协调）
