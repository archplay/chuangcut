# 静态代码分析 - 数据库层

> **分析目标**：通过阅读代码发现数据访问层的安全性和正确性问题
> **涉及文件**：22 个文件，约 3000 行代码
> **优先级**：P0（数据安全）
> **预计耗时**：90 分钟

---

## 测试目的

**核心目标**：通过静态代码分析，发现数据库层中可能导致数据泄露、SQL注入、数据不一致的安全和正确性问题，确保数据存储的安全性和完整性。

**具体要求**：
1. **全面分析**：仔细阅读每个代码文件，不得遗漏任何可能的问题点
2. **问题分类**：按 P0（致命）、P1（严重）、P2（中等）、P3（轻微）优先级分类
3. **修复方案**：针对发现的问题，给出简洁高效的最优化修复方案
4. **代码简洁**：修复方案需保持代码简洁，避免过度设计

**修复原则**：
- ✅ **保证功能正常**：修复后必须确保现有功能正常运行
- ✅ **不引入新错误**：修复方案不得引入新的报错或问题
- ✅ **面向现有功能**：非必要不兼容历史数据，优先满足当前功能需求
- ❌ **避免过度设计**：不为假设的未来需求增加复杂性

**重点关注**：
- SQL 注入防护（参数化查询）
- AES-256-GCM 加密实现正确性
- 事务边界和数据一致性
- JSON 字段序列化安全
- 分布式锁的正确使用

---

## 一、模块概述

### 1.1 功能描述

数据库层负责：
- 所有数据的持久化存储（SQLite + WAL 模式）
- SQL 查询的安全执行
- 事务管理和数据一致性
- API 密钥的加密存储（AES-256-GCM）
- 分布式锁实现

### 1.2 架构设计

```
lib/db/
├── index.ts               # 数据库入口
├── schema.sql             # 数据库 Schema 定义
├── core/                  # 核心数据访问
│   ├── jobs.ts           # 任务管理（390 行）
│   ├── api-keys.ts       # API 密钥（加密）
│   ├── configs.ts        # 系统配置
│   └── users.ts          # 用户管理
├── tables/               # 表级别操作
│   ├── job-scenes.ts     # 分镜数据
│   ├── job-logs.ts       # 任务日志
│   ├── job-videos.ts     # 视频数据
│   └── ...
├── managers/             # 数据管理器
│   └── runtime-data-loader.ts
└── utils/
    └── query-helpers.ts  # SQL 查询辅助
```

### 1.3 关键文件列表

| 文件 | 行数 | 职责 |
|------|------|------|
| `core/jobs.ts` | 390 | 任务 CRUD，状态管理 |
| `core/api-keys.ts` | ~200 | API 密钥加密存储 |
| `schema.sql` | ~400 | 数据库表结构定义 |
| `utils/query-helpers.ts` | ~150 | SQL 查询构建辅助 |
| `managers/runtime-data-loader.ts` | ~200 | 运行时数据加载 |

---

## 二、分析检查清单

### 2.1 SQL 安全

| 检查项 | 文件 | 检查内容 | 状态 |
|--------|------|----------|------|
| SA-DB-001 | `core/*.ts` | SQL 注入风险（是否使用参数化查询） | ⬜ |
| SA-DB-002 | `query-helpers.ts` | 动态 SQL 构建的安全性 | ⬜ |
| SA-DB-003 | `core/*.ts` | ORDER BY / LIMIT 参数是否被过滤 | ⬜ |
| SA-DB-004 | `tables/*.ts` | 表名/列名是否硬编码（防止注入） | ⬜ |

### 2.2 事务与一致性

| 检查项 | 文件 | 检查内容 | 状态 |
|--------|------|----------|------|
| SA-DB-005 | `transaction.ts` | 事务边界和回滚逻辑 | ⬜ |
| SA-DB-006 | `transaction.ts` | 嵌套事务处理（savepoint 使用） | ⬜ |
| SA-DB-007 | `core/jobs.ts` | 状态更新的原子性（多表更新） | ⬜ |
| SA-DB-008 | `core/*.ts` | 乐观锁/悲观锁使用正确性 | ⬜ |

### 2.3 数据序列化

| 检查项 | 文件 | 检查内容 | 状态 |
|--------|------|----------|------|
| SA-DB-009 | `jobs.ts` | JSON 字段序列化安全性（null/undefined 处理） | ⬜ |
| SA-DB-010 | `jobs.ts` | JSON 解析异常处理 | ⬜ |
| SA-DB-011 | `tables/*.ts` | 日期时间字段格式一致性 | ⬜ |

### 2.4 加密与安全

| 检查项 | 文件 | 检查内容 | 状态 |
|--------|------|----------|------|
| SA-DB-012 | `api-keys.ts` | AES-256-GCM 加密实现正确性 | ⬜ |
| SA-DB-013 | `api-keys.ts` | IV 生成随机性和唯一性 | ⬜ |
| SA-DB-014 | `api-keys.ts` | 密钥派生函数使用 | ⬜ |

### 2.5 Schema 设计

| 检查项 | 文件 | 检查内容 | 状态 |
|--------|------|----------|------|
| SA-DB-015 | `schema.sql` | 外键约束和级联删除 | ⬜ |
| SA-DB-016 | `schema.sql` | 索引设计合理性 | ⬜ |
| SA-DB-017 | `schema.sql` | NOT NULL 约束是否合理 | ⬜ |
| SA-DB-018 | `schema.sql` | 默认值设置正确性 | ⬜ |

### 2.6 并发控制

| 检查项 | 文件 | 检查内容 | 状态 |
|--------|------|----------|------|
| SA-DB-019 | `core/*.ts` | WAL 模式下的并发处理 | ⬜ |
| SA-DB-020 | `core/*.ts` | busy_timeout 配置是否合理 | ⬜ |
| SA-DB-021 | `distributed-lock.ts` | 分布式锁实现正确性 | ⬜ |

### 2.7 输入验证

| 检查项 | 文件 | 检查内容 | 状态 |
|--------|------|----------|------|
| SA-DB-022 | `tables/*.ts` | 输入数据长度限制 | ⬜ |
| SA-DB-023 | `tables/*.ts` | 枚举值范围验证 | ⬜ |
| SA-DB-024 | `managers/*.ts` | 外键引用完整性检查 | ⬜ |

---

## 三、关键代码审查

### 3.1 core/jobs.ts - 任务管理

**审查重点**：
- [ ] SQL 参数化查询
- [ ] JSON 字段处理
- [ ] 状态更新原子性

**代码位置**：`lib/db/core/jobs.ts`

**需要检查的关键函数**：
- `createJob()`：创建任务
- `updateJobStatus()`：更新任务状态
- `getJobById()`：获取任务详情
- `deleteJob()`：删除任务

**检查要点**：

1. **SQL 注入防护**
   - 正确：使用 `db.prepare('SELECT * FROM jobs WHERE id = ?').get(id)`
   - 错误：使用字符串拼接构建 SQL

2. **JSON 字段处理**
   - 序列化时 null/undefined 处理
   - 反序列化时异常处理

3. **状态更新原子性**
   - 多表更新是否在事务中

---

### 3.2 core/api-keys.ts - API 密钥加密

**审查重点**：
- [ ] AES-256-GCM 实现
- [ ] IV 随机性
- [ ] 密钥安全

**代码位置**：`lib/db/core/api-keys.ts`

**需要检查的关键函数**：
- `encryptApiKey()`：加密 API 密钥
- `decryptApiKey()`：解密 API 密钥
- `generateIV()`：生成初始化向量

**检查要点**：

1. **加密模式**
   - 确认使用 GCM 模式（提供认证）
   - 检查 `aes-256-gcm` 算法使用

2. **IV 生成**
   - 确认使用 CSPRNG（crypto.randomBytes）
   - GCM 推荐 12 字节 IV
   - 检查 IV 是否被重用（严重漏洞）

3. **密钥派生**
   - 检查是否使用 PBKDF2/scrypt

---

### 3.3 schema.sql - 数据库结构

**审查重点**：
- [ ] 表结构设计
- [ ] 约束定义
- [ ] 索引设计

**代码位置**：`lib/db/schema.sql`

**检查要点**：

1. **外键约束**
   - 是否定义了外键
   - 级联删除是否合理

2. **索引设计**
   - 常用查询字段是否有索引
   - 索引是否过多影响写入性能

3. **NOT NULL 约束**
   - 必填字段是否有 NOT NULL
   - 默认值是否合理

---

### 3.4 utils/query-helpers.ts - 查询辅助

**审查重点**：
- [ ] 动态 SQL 安全性
- [ ] 参数验证
- [ ] 注入防护

**代码位置**：`lib/db/utils/query-helpers.ts`

**检查要点**：

1. **动态 ORDER BY**
   - 是否白名单验证列名
   - 避免直接使用用户输入

2. **动态 WHERE 条件**
   - 条件构建是否安全
   - 参数是否正确绑定

---

### 3.5 managers/runtime-data-loader.ts - 运行时数据加载

**审查重点**：
- [ ] 数据完整性验证
- [ ] 缓存一致性
- [ ] 错误处理

**代码位置**：`lib/db/managers/runtime-data-loader.ts`

**检查要点**：

1. **数据完整性**
   - 加载数据后是否验证完整性
   - 关联数据是否一致

2. **缓存处理**
   - 缓存和数据库是否同步
   - 缓存失效策略

---

## 四、发现的问题

> 在实际分析代码后填写此部分

### 问题模板

**严重程度**：P0/P1/P2/P3
**文件位置**：`lib/db/xxx.ts:123`
**检查项**：SA-DB-XXX

**问题描述**：
（详细描述发现的问题）

**风险分析**：
（可能导致的后果）

**修复建议**：
（建议的修复方案）

---

## 五、分析结果汇总

| 指标 | 数值 |
|------|------|
| 检查项总数 | 24 |
| 已检查 | 0 |
| 发现问题 | 0 |
| P0 问题 | 0 |
| P1 问题 | 0 |
| P2 问题 | 0 |
| P3 问题 | 0 |

### 按类别统计

| 类别 | 检查项数 | 问题数 |
|------|---------|--------|
| SQL 安全 | 4 | 0 |
| 事务与一致性 | 4 | 0 |
| 数据序列化 | 3 | 0 |
| 加密与安全 | 3 | 0 |
| Schema 设计 | 4 | 0 |
| 并发控制 | 3 | 0 |
| 输入验证 | 3 | 0 |

---

## 六、修复方案

> 在发现问题后，针对每个问题给出具体的修复代码示例

### 常见修复模式

**SQL 参数化查询**：
- 使用 `db.prepare().get/all/run()` 而非字符串拼接
- 所有外部输入通过参数占位符 `?` 传入

**JSON 安全解析**：
- 使用 try-catch 包装 JSON.parse
- 提供默认值处理解析失败情况

**事务使用**：
- 多表操作使用 `db.transaction()` 包装
- 确保异常时自动回滚

---

## 附录：相关代码路径

```
lib/db/
├── index.ts
├── schema.sql
├── core/
│   ├── jobs.ts
│   ├── api-keys.ts
│   ├── configs.ts
│   └── users.ts
├── tables/
│   ├── job-scenes.ts
│   ├── job-logs.ts
│   ├── job-videos.ts
│   ├── job-step-history.ts
│   ├── scene-audio-candidates.ts
│   └── api-calls.ts
├── managers/
│   └── runtime-data-loader.ts
└── utils/
    └── query-helpers.ts
```
