# 测试用例 - 任务工作流（云端）

> **测试环境**：云端（Zeabur）
> **测试工具**：MCP Chrome DevTools
> **预计耗时**：90 分钟
> **用例数量**：20 个
> **前置条件**：已完成「01-云端-UI基础功能」的密钥配置

---

## 测试目的

**核心目标**：通过端到端测试验证完整的视频处理工作流，确保从任务创建到最终成片的全流程正确执行。

**修复原则**：
- ✅ **保证功能正常**：修复后必须确保现有功能正常运行
- ✅ **不引入新错误**：修复方案不得引入新的报错或问题
- ✅ **面向现有功能**：非必要不兼容历史数据，优先满足当前功能需求
- ❌ **避免过度设计**：不为假设的未来需求增加复杂性

---

## 测试凭据

> **重要**：测试凭据和资源请参考以下文件，本文档不包含敏感信息。

| 凭据类型 | 参考文件 |
|----------|----------|
| 环境地址、账号密码 | [凭据/云端.md](../凭据/云端.md) |
| 测试视频、API 配置模板 | [凭据/公共.md](../凭据/公共.md) |

> ⚠️ **注意**：测试视频为**美食类**视频，请在测试时注意验证 AI 生成的旁白内容与美食主题相关。

---

## 通用验证规范

### 每个测试用例必须验证

1. **控制台监控**：无 JavaScript 错误、无未捕获异常
2. **网络请求监控**：API 请求返回正确状态码
3. **UI 响应**：操作后界面正确更新
4. **API 响应验证**：通过 `/api/jobs/:id` 获取任务数据进行验证

### 云端数据验证方式

> 云端环境无法直接访问数据库，通过 API 响应验证数据

| 验证途径 | 说明 |
|----------|------|
| `/api/jobs/:id` | 任务详情（包含 state、stepHistory、scenes） |
| `/api/jobs/:id/cost` | 成本统计（包含 API 调用记录） |
| `/api/jobs/:id/logs` | 任务日志 |
| 任务详情页 UI | 分镜列表、日志面板、步骤历史 |

---

## 第一部分：风格准备测试

### TC-STYLE-001 通用风格检查

**操作**：导航到风格管理页面，查看「通用解说风格」（style-1000）

**UI 验证**：
- [ ] 预设风格列表包含 14 个风格
- [ ] style-1000 存在且可查看详情
- [ ] 详情页显示 analysis_creative_layer 和 audio_sync_creative_layer

**参数验证**：
- channel_name = `翔宇通用`
- duration_range = `6-12`
- speech_rates = `[4, 4.5, 5.5]`

---

### TC-STYLE-002 创建测试专用自定义风格

**操作**：创建自定义风格，用于后续参数验证测试

**风格配置**：

| 参数 | 值 |
|------|-----|
| 风格名称 | `测试全参数风格` |
| channel_name | `美食测试频道` |
| duration_range | `4-8` |
| speech_rates | `[3.5, 4.5, 5.5]` |

**剪辑提示词要求**：包含指令让 AI 在旁白中添加「[剪辑参数生效]」标记

**音画提示词要求**：包含指令让 AI 在优化旁白中添加「[音画参数生效]」标记

**UI 验证**：
- [ ] 风格保存成功，显示在自定义风格列表
- [ ] 记录风格 ID（用于后续测试）

---

## 第二部分：通用风格任务测试

### TC-JOB-001 通用风格单视频任务（AI Studio）

**任务参数**：

| 参数 | 值 |
|------|-----|
| 视频 URL | 测试视频1 |
| 风格 | 通用解说风格（style-1000） |
| Gemini 平台 | AI Studio |
| 分镜数量 | 4 |
| 原声分镜 | 0 |
| 文案大纲 | `这是一道经典美食的制作过程，请围绕食材准备、烹饪技巧、成品展示进行解说` |

**UI 验证**：
- [ ] 任务创建成功，跳转到详情页
- [ ] 任务状态最终变为「已完成」
- [ ] 分镜数量 = 4

**API 响应验证**（通过 `/api/jobs/:id`）：

| 字段路径 | 验证要求 |
|----------|----------|
| `status` | = `completed` |
| `style_id` | = `style-1000` |
| `scenes.length` | = 4 |
| `scenes[*].use_original_audio` | 所有 = 0 |
| `scenes[*].duration_seconds` | 在 6-12 秒范围 |
| `state.final_video_url` | 不为空 |
| `stepHistory` | 五个阶段都有记录 |

**异常监控**：
- [ ] 控制台无错误
- [ ] 网络请求无 5xx 错误

---

### TC-JOB-002 通用风格单视频任务（Vertex AI）

**任务参数**：

| 参数 | 值 |
|------|-----|
| 视频 URL | 测试视频1 |
| 风格 | 通用解说风格（style-1000） |
| Gemini 平台 | Vertex AI |
| 分镜数量 | 3 |
| 原声分镜 | 1 |
| 文案大纲 | 同上 |

**UI 验证**：
- [ ] 任务创建成功
- [ ] 任务状态最终变为「已完成」
- [ ] 日志中显示 `gs://` URI

**API 响应验证**：

| 字段路径 | 验证要求 |
|----------|----------|
| `config.gemini_platform` | = `vertex` |
| `scenes[-1].use_original_audio` | = 1（最后一个分镜为原声） |
| `stepHistory` | 包含 migrate_to_gcs 步骤 |

---

## 第三部分：自定义风格任务测试

### TC-JOB-003 自定义风格单视频任务（AI Studio）

**任务参数**：

| 参数 | 值 |
|------|-----|
| 视频 URL | 测试视频1 |
| 风格 | 测试全参数风格（TC-STYLE-002 创建的） |
| Gemini 平台 | AI Studio |
| 分镜数量 | 3 |
| 原声分镜 | 0 |
| 文案大纲 | `这是一道经典美食的制作过程，厨师的名字叫王大厨，请在解说中提及王大厨的名字` |

**UI 验证**：
- [ ] 任务创建成功
- [ ] 任务完成

**参数生效验证**（通过 API 或导出报告）：

| 验证项 | 验证要求 |
|--------|----------|
| **channel_name** | 日志或导出报告中包含 `美食测试频道` |
| **duration_range** | 所有分镜 duration_seconds 在 **4-8 秒**范围 |
| **[剪辑参数生效]** | 分镜 narration_script 包含此标记 |
| **[音画参数生效]** | 音频候选 narration_text 包含此标记 |
| **文案大纲** | narration_script 包含「王大厨」 |

**对比验证（与 TC-JOB-001）**：
- 分镜时长：自定义风格（4-8秒）< 通用风格（6-12秒）

---

### TC-JOB-004 自定义风格多视频混剪任务

**任务参数**：

| 参数 | 值 |
|------|-----|
| 视频 1 | 测试视频1 |
| 视频 2 | 测试视频2 |
| 风格 | 测试全参数风格 |
| Gemini 平台 | AI Studio |
| 分镜数量 | 4 |
| 原声分镜 | 1 |
| 文案大纲 | `这是美食合集，两道菜都由李师傅亲手烹制，请在解说中提及李师傅` |

**UI 验证**：
- [ ] 任务类型显示为多视频
- [ ] 任务完成

**API 响应验证**：

| 字段路径 | 验证要求 |
|----------|----------|
| `job_type` | = `multi_video` |
| `input_videos.length` | = 2 |
| `scenes.length` | = 4 |
| `scenes[-1].use_original_audio` | = 1 |
| `scenes[*].narration_script` | 包含「李师傅」 |

---

## 第四部分：工作流五阶段监控测试

> **说明**：在任务执行过程中，监控五个阶段的执行状态

### TC-WF-001 阶段1-视频分析（analysis）

**监控步骤**：fetch_metadata → prepare_gemini → gemini_analysis → validate_storyboards

**验证要求**：

| 验证项 | 要求 |
|--------|------|
| 步骤历史 | 四个子步骤都有记录，status=completed |
| 视频元数据 | metadata 不为空 |
| Gemini URI | gemini_uri 不为空 |
| 分镜脚本 | storyboards 不为空 |

---

### TC-WF-002 阶段2-旁白生成（generate_narrations）

**监控步骤**：generate_narrations（批量生成旁白）

**验证要求**：

| 验证项 | 要求 |
|--------|------|
| 步骤历史 | generate_narrations 步骤 status=completed |
| 旁白脚本 | 所有分镜 narration_script 不为空 |

---

### TC-WF-003 阶段3-分镜提取（extract_scenes）

**监控步骤**：ffmpeg_batch_split, migrate_to_gcs（仅 Vertex AI）

**验证要求**：

| 验证项 | 要求 |
|--------|------|
| 步骤历史 | ffmpeg_batch_split 步骤 status=completed |
| 分镜视频 | 所有分镜 split_video_url 不为空 |

---

### TC-WF-004 阶段4-音画同步（process_scenes）

**监控步骤**：synthesize_audio → select_best_match → adjust_video_speed → merge_audio_video

**验证要求**：

| 验证项 | 要求 |
|--------|------|
| 音频候选 | 每个分镜有 3 个候选 |
| 选中候选 | 每个分镜有 1 个 is_selected=1 |
| 速度因子 | 被选中的候选 speed_factor 最接近 1.0 |
| 最终视频 | 所有分镜 final_video_url 不为空 |

---

### TC-WF-005 阶段5-最终合成（compose）

**监控步骤**：concatenate_scenes, upload_final_video（仅 Vertex AI）, download_to_local

**验证要求**：

| 验证项 | 要求 |
|--------|------|
| 步骤历史 | concatenate_scenes 步骤 status=completed |
| 最终视频 | final_video_url 不为空 |
| 任务状态 | status=completed, completed_at 不为空 |

---

## 第五部分：参数微调验证测试

> **说明**：通过对比通用风格（TC-JOB-001）和自定义风格（TC-JOB-003）的 API 响应，验证参数生效

### TC-PARAM-001 参数验证-分镜数量

**验证要求**：
- TC-JOB-003 的 scenes.length = 3
- TC-JOB-004 的 scenes.length = 4

---

### TC-PARAM-002 参数验证-原声分镜

**验证要求**：
- TC-JOB-003：所有分镜 use_original_audio = 0
- TC-JOB-004：最后 1 个分镜 use_original_audio = 1

---

### TC-PARAM-003 参数验证-文案大纲

**验证要求**：
- TC-JOB-003 分镜旁白包含「王大厨」
- TC-JOB-004 分镜旁白包含「李师傅」

---

### TC-PARAM-004 参数验证-特殊标记（剪辑提示词）

**验证要求**：
- TC-JOB-001（通用风格）：旁白**不包含**「[剪辑参数生效]」
- TC-JOB-003（自定义风格）：旁白**包含**「[剪辑参数生效]」

---

### TC-PARAM-005 参数验证-特殊标记（音画提示词）

**验证要求**：
- TC-JOB-001（通用风格）：音频候选**不包含**「[音画参数生效]」
- TC-JOB-003（自定义风格）：音频候选**包含**「[音画参数生效]」

---

### TC-PARAM-006 参数验证-频道名称

**验证要求**：
- TC-JOB-001：日志/导出报告中 channel_name = `翔宇通用`
- TC-JOB-003：日志/导出报告中 channel_name = `美食测试频道`

---

### TC-PARAM-007 参数验证-分镜时长范围

**验证要求**：
- TC-JOB-001（通用风格）：所有分镜在 **6-12 秒**范围
- TC-JOB-003（自定义风格）：所有分镜在 **4-8 秒**范围
- 自定义风格平均时长 < 通用风格平均时长

---

### TC-PARAM-008 参数验证-语速配置

**验证要求**：
- 通用风格候选旁白长度比例约为 4/4.5/5.5
- 自定义风格候选旁白长度比例约为 3.5/4.5/5.5
- 候选 0 的旁白长度：通用 > 自定义

---

## 第六部分：导出功能测试

### TC-EXPORT-001 导出任务数据

**操作**：在 TC-JOB-003 任务详情页点击「导出数据」

**UI 验证**：
- [ ] 导出成功，打开 Markdown 报告
- [ ] 报告包含任务基本信息
- [ ] 报告包含分镜脚本
- [ ] 报告中可见「[剪辑参数生效]」标记

---

## 第七部分：风格对比总结

### TC-COMPARE-001 通用风格 vs 自定义风格对比

**对比维度**：

| 对比项 | 通用风格（TC-JOB-001） | 自定义风格（TC-JOB-003） | 预期差异 |
|--------|------------------------|--------------------------|----------|
| channel_name | 翔宇通用 | 美食测试频道 | 不同 |
| duration_range | 6-12秒 | 4-8秒 | 不同 |
| speech_rates[0] | 4 | 3.5 | 不同 |
| [剪辑参数生效] | 无 | 有 | 仅自定义有 |
| [音画参数生效] | 无 | 有 | 仅自定义有 |

**验证方式**：
- 从两个任务的 API 响应或导出报告中提取上述字段进行对比
- 所有差异项都应符合预期

---

## 问题记录模板

```markdown
### 问题 N
- **用例编号**：TC-XXX-XXX
- **位置**：[页面/功能]
- **现象**：[描述]
- **控制台错误**：[如有]
- **API 响应异常**：[如有]
- **修复状态**：☐ 待修复 / ☐ 已修复
```

---

## 测试结果汇总

| 用例编号 | 用例名称 | 结果 | 备注 |
|----------|----------|------|------|
| TC-STYLE-001 | 通用风格检查 | ☐ 通过 / ☐ 失败 | |
| TC-STYLE-002 | 创建测试专用自定义风格 | ☐ 通过 / ☐ 失败 | |
| TC-JOB-001 | 通用风格单视频（AI Studio） | ☐ 通过 / ☐ 失败 | |
| TC-JOB-002 | 通用风格单视频（Vertex AI） | ☐ 通过 / ☐ 失败 | |
| TC-JOB-003 | 自定义风格单视频（AI Studio） | ☐ 通过 / ☐ 失败 | |
| TC-JOB-004 | 自定义风格多视频混剪 | ☐ 通过 / ☐ 失败 | |
| TC-WF-001 | 阶段1-视频分析 | ☐ 通过 / ☐ 失败 | |
| TC-WF-002 | 阶段2-分镜提取 | ☐ 通过 / ☐ 失败 | |
| TC-WF-003 | 阶段3-音画同步 | ☐ 通过 / ☐ 失败 | |
| TC-WF-004 | 阶段4-最终合成 | ☐ 通过 / ☐ 失败 | |
| TC-PARAM-001 | 参数验证-分镜数量 | ☐ 通过 / ☐ 失败 | |
| TC-PARAM-002 | 参数验证-原声分镜 | ☐ 通过 / ☐ 失败 | |
| TC-PARAM-003 | 参数验证-文案大纲 | ☐ 通过 / ☐ 失败 | |
| TC-PARAM-004 | 参数验证-特殊标记（剪辑） | ☐ 通过 / ☐ 失败 | |
| TC-PARAM-005 | 参数验证-特殊标记（音画） | ☐ 通过 / ☐ 失败 | |
| TC-PARAM-006 | 参数验证-频道名称 | ☐ 通过 / ☐ 失败 | |
| TC-PARAM-007 | 参数验证-分镜时长范围 | ☐ 通过 / ☐ 失败 | |
| TC-PARAM-008 | 参数验证-语速配置 | ☐ 通过 / ☐ 失败 | |
| TC-EXPORT-001 | 导出任务数据 | ☐ 通过 / ☐ 失败 | |
| TC-COMPARE-001 | 通用 vs 自定义风格对比 | ☐ 通过 / ☐ 失败 | |

---

**测试人员**：________________

**测试日期**：________________

**测试结论**：☐ 全部通过 / ☐ 部分通过 / ☐ 需修复后重测
