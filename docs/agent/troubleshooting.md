# 故障排查

## 常见问题

### 授权相关

#### 授权码验证失败

**症状**：启动时报 403 错误

**排查**：
1. 检查 `LICENSE_KEY` 环境变量是否正确设置
2. 确认授权码格式：`CCUT-{8-14字符}-{4字符}`
3. 检查授权码是否过期

#### Session 失效

**症状**：登录后很快需要重新登录

**排查**：
1. 检查 `SESSION_SECRET` 是否正确配置
2. Session 有效期固定为 7 天（代码内置，不可配置）

### 数据库相关

#### 数据库初始化失败

**排查**：
```bash
# 手动初始化
pnpm db:init

# 检查数据库文件权限
ls -la data/db.sqlite
```

#### 数据库锁定

**症状**：`SQLITE_BUSY` 错误

**排查**：
1. 确认没有多个进程同时写入
2. 检查 WAL 模式是否启用

### Gemini 相关

#### 上传文件失败

**症状**：文件上传到 Gemini 超时

**排查**：
1. **Vertex AI**：检查 Service Account 权限、GCS Bucket 配置
2. **AI Studio**：确认文件大小 < 500MB

#### 模型不可用

**症状**：指定模型不可用

**解决**：系统回退模型为 `gemini-2.5-pro`，可在设置中配置其他模型

### FFmpeg 相关

#### FFmpeg 处理失败

**症状**：视频拆条、调速或合成失败

**排查**：
1. 检查临时目录权限：`ls -la /tmp/ffmpeg/`
2. 确认 FFmpeg 可执行：`ffmpeg -version`
3. 查看详细日志：`LOG_LEVEL=debug`
4. 检查磁盘空间：`df -h /tmp`

### Docker 相关

#### 镜像架构不匹配

**症状**：Zeabur 部署后容器无法启动

**解决**：必须构建多平台镜像（amd64 + arm64）

```bash
docker buildx build \
  --platform "linux/amd64,linux/arm64" \
  --tag "xiangyugongzuoliu/chuangcut-video-workflow:latest" \
  --push \
  .
```

## 调试技巧

### 启用详细日志

```bash
LOG_LEVEL=debug
ENABLE_DEBUG_LOGS=true
```

### 查看任务日志

```bash
# API 方式
curl http://localhost:8899/api/jobs/{job_id}/logs

# 数据库查询
sqlite3 data/db.sqlite "SELECT * FROM job_logs WHERE job_id = 'xxx' ORDER BY created_at DESC LIMIT 100"
```

### 检查任务状态

```sql
-- 当前状态
SELECT * FROM job_current_state WHERE job_id = 'xxx';

-- 步骤历史
SELECT * FROM job_step_history WHERE job_id = 'xxx' ORDER BY created_at;
```

### 查看 API 调用记录

```sql
SELECT * FROM api_calls WHERE job_id = 'xxx' ORDER BY created_at DESC;
```

## 任务控制

### 任务状态说明

| 状态 | 说明 | 是否终态 |
|-----|------|---------|
| `pending` | 待处理 | 否 |
| `processing` | 执行中 | 否 |
| `completed` | 已完成 | **是** |
| `failed` | 已失败 | **是** |

### 停止任务

> **注意**：v12.1.0 起已移除停止任务功能。任务启动后会持续执行直到完成或失败。
>
> 如需中止任务，可以删除任务（见下方），系统会自动清理相关资源。

### 删除任务

```bash
curl -X DELETE http://localhost:8899/api/jobs/{job_id}
```

### 手动清理（仅用于开发调试）

```sql
-- 清理步骤历史
DELETE FROM job_step_history WHERE job_id = 'xxx';

-- 重置任务状态（不推荐在生产环境使用）
UPDATE jobs SET status = 'pending', error_message = NULL WHERE id = 'xxx';
```
