# 重试机制与错误处理

## 架构概览

项目采用**三层递进式重试策略**，处理网络错误、429 限流、格式错误等多种场景。

```
┌─────────────────────────────────────────────────────────────────┐
│ 第3层：格式校验重试                                              │
│ BatchFormatError → withRetry (2次, 2秒固定延迟)                  │
├─────────────────────────────────────────────────────────────────┤
│ 第2层：429 限流专用                                              │
│ geminiRateLimiter → 请求队列化 + 指数退避 (4-60次, 8-60秒)       │
├─────────────────────────────────────────────────────────────────┤
│ 第1层：通用短等待重试                                            │
│ withRetry → 网络/超时/5xx错误 (3次, 1-4秒指数退避)               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 重试策略汇总

| 机制 | 最大次数 | 初始延迟 | 退避策略 | 最大延迟 | 总等待时间 | 适用场景 |
|------|---------|---------|---------|---------|-----------|---------|
| `withRetry()` | 3 次 | 1,000ms | 2x 指数 | ~4,000ms | ~7 秒 | 网络/超时/5xx |
| `geminiRateLimiter` (AI Studio) | 60 次 | 10,000ms | 2x 指数 | 60,000ms | ~60 分钟 | 429 限流 |
| `geminiRateLimiter` (Vertex) | 4 次 | 8,000ms | 2x 指数 | 45,000ms | ~2 分钟 | 429 限流 |
| `BatchFormatError` 重试 | 2 次 | 2,000ms | 无 (固定) | 2,000ms | ~4 秒 | 格式校验 |
| `downloadWithResume()` | 20 次 | 60,000ms | 无 (固定) | 60,000ms | ~20 分钟 | 视频下载 |

**延迟计算公式**:
- **指数退避**: `delay = initialDelay × backoff^(attempt-1)`
- **固定延迟**: `delay = initialDelay`

---

## 核心处理程序

### 1. withRetry() - 通用重试

**文件**: `lib/utils/retry.ts:3-47`

```typescript
async function withRetry<T>(
  fn: () => Promise<T>,
  options: {
    maxAttempts?: number      // 默认 3
    delayMs?: number          // 默认 1000ms
    backoff?: number          // 默认 2（指数退避）
    shouldRetry?: (error) => boolean
    onRetry?: (attempt, error) => void
  }
): Promise<T>
```

**延迟计算**: `delay = delayMs × backoff^(attempt-1)`

**默认配置**: 3 次重试，1→2→4 秒指数退避

---

### 2. isRetryableError() - 可重试错误判断

**文件**: `lib/utils/retry.ts:55-123`

| 错误类型 | 匹配模式 |
|---------|---------|
| 网络错误 | `network`, `fetch failed`, `ECONNRESET`, `ECONNREFUSED`, `ETIMEDOUT`, `socket timeout` |
| 超时错误 | `timeout`, `timed out`, `request timeout` |
| 服务器错误 | `internal server error`, `service unavailable`, `bad gateway` |
| Gemini 特定 | `deadline exceeded`, `unavailable` |
| Fish Audio | `service temporarily unavailable` |
| 文件处理 | `file failed to be processed` |
| JSON 解析 | `json parse`, `unexpected token`, `invalid json` |
| HTTP 状态码 | `408`, `500`, `502`, `503`, `504` |

**注意**: 429 错误**不在此列表**，由 `geminiRateLimiter` 专门处理

---

### 3. geminiRateLimiter - 429 限流专用

**文件**: `lib/ai/gemini/core/rate-limiter.ts`

#### 平台配置

| 平台 | minIntervalMs | maxRetries | maxWaitMs | initialWaitMs |
|------|--------------|-----------|----------|--------------|
| AI Studio | 10,000ms | 60 次 | 60 秒 | 10 秒 |
| Vertex AI | 1,000ms | 4 次 | 45 秒 | 8 秒 |

#### is429Error() - 429 检测

**文件**: `lib/ai/gemini/core/rate-limiter.ts:50-65`

| 匹配模式 |
|---------|
| `429` |
| `resource_exhausted` |
| `resource exhausted` |
| `quota exceeded` |
| `rate limit` |
| `too many requests` |

#### 核心特性

- **请求队列化**: 同一时间只有 1 个请求执行
- **指数退避**: `waitTime = min(initialWait × 2^(attempt-1), maxWaitMs)`
- **Retry-After 支持**: 从响应头提取等待时间

---

### 4. downloadWithResume() - 视频下载重试

**文件**: `lib/media/utils/download.ts:52-121`

```typescript
export async function downloadWithResume(options: {
  url: string
  destPath: string
  maxRetries?: number     // 默认 20
  retryDelay?: number     // 默认 60000ms (60秒)
}): Promise<DownloadResult>
```

**重试策略**:
- **重试次数**: 20 次
- **重试间隔**: 60 秒（固定，无指数退避）
- **总等待时间**: 最长约 20 分钟
- **断点续传**: ✅ 支持 HTTP Range 请求

**特性**:
- 网络中断后自动从已下载位置继续
- 下载完成后校验文件大小
- 适用于大文件（2GB+）下载

---

### 5. BatchFormatError - 格式校验重试

**文件**: `lib/ai/gemini/index.ts:41-50`

```typescript
class BatchFormatError extends Error {
  constructor(
    message: string,
    public readonly rawResponse: string,
    public readonly rawFormat: string
  )
}
```

**重试配置** (`lib/ai/gemini/index.ts:385-408`):

```typescript
{
  maxAttempts: 2,     // 2 次重试
  delayMs: 2000,      // 固定 2 秒
  backoff: 1,         // 无指数退避
  shouldRetry: (error) => error instanceof BatchFormatError
}
```

---

## 错误处理完整矩阵

### 网络层错误

| 错误 | 触发条件 | 处理程序 | 重试策略 | 代码位置 |
|------|---------|---------|---------|---------|
| 网络超时 | `ETIMEDOUT` | `withRetry()` + `isRetryableError()` | 3次, 1→2→4秒 | `retry.ts:72` |
| 连接重置 | `ECONNRESET` | `withRetry()` + `isRetryableError()` | 3次, 1→2→4秒 | `retry.ts:70` |
| 连接拒绝 | `ECONNREFUSED` | `withRetry()` + `isRetryableError()` | 3次, 1→2→4秒 | `retry.ts:71` |
| 服务不可用 | `503/502/504` | `withRetry()` + `isRetryableError()` | 3次, 1→2→4秒 | `retry.ts:86-87` |
| DNS 解析失败 | `ENOTFOUND` | `withRetry()` + `isRetryableError()` | 3次, 1→2→4秒 | `retry.ts:75` |

### 429 限流错误

| 错误 | 触发条件 | 处理程序 | 重试策略 | 代码位置 |
|------|---------|---------|---------|---------|
| 配额耗尽 | `RESOURCE_EXHAUSTED` | `geminiRateLimiter` | AI Studio: 60次, 10-60秒 | `rate-limiter.ts:57` |
| 速率限制 | `rate limit` | `geminiRateLimiter` | Vertex: 4次, 8-45秒 | `rate-limiter.ts:60` |
| 请求过多 | `too many requests` | `geminiRateLimiter` | 指数退避 | `rate-limiter.ts:61` |

### 输出内容错误

| 错误 | 触发条件 | 处理程序 | 可修复 | 代码位置 |
|------|---------|---------|--------|---------|
| 空响应 | `!response.text` | ❌ 无 | ❌ | `generate.ts:193` |
| SAFETY 阻止 | `finishReason=SAFETY` | ❌ 无 | ❌ | `generate.ts:200` |
| RECITATION 阻止 | `finishReason=RECITATION` | ❌ 无 | ❌ | `generate.ts:201` |
| BLOCKLIST 阻止 | `finishReason=BLOCKLIST` | ❌ 无 | ❌ | `generate.ts:202` |
| SPII 阻止 | `finishReason=SPII` | ❌ 无 | ❌ | `generate.ts:204` |
| MAX_TOKENS 截断 | `finishReason=MAX_TOKENS` | `repairTruncatedJson()` | ✅ | `json-extractor.ts:58` |

### JSON 格式错误

| 错误 | 触发条件 | 处理程序 | 可修复 | 代码位置 |
|------|---------|---------|--------|---------|
| 尾逗号 | `{"a": 1,}` | `sanitizeJson()` | ✅ | `json-extractor.ts:179` |
| 重复逗号 | `{"a": 1,, "b": 2}` | `sanitizeJson()` | ✅ | `json-extractor.ts:182` |
| 缺失逗号 | `{"a": 1 "b": 2}` | `sanitizeJson()` | ✅ | `json-extractor.ts:185-194` |
| 控制字符 | `\x00` 等 | `sanitizeJson()` | ✅ | `json-extractor.ts:205` |
| 未闭合字符串 | `{"a": "text` | `sanitizeJson()` | ✅ | `json-extractor.ts:199-202` |
| 括号不平衡 | `{"a": [1, 2` | `repairTruncatedJson()` | ✅ | `json-extractor.ts:58-96` |
| 复杂语法错误 | 规则无法修复 | `repairJsonWithAI()` | ✅ | `json-repair.ts:42-101` |

### 业务格式错误

| 错误 | 触发条件 | 处理程序 | 重试策略 | 代码位置 |
|------|---------|---------|---------|---------|
| storyboards vs scenes | 返回 `storyboards` | `BatchFormatError` + `withRetry()` | 2次, 2秒 | `index.ts:370-408` |
| 数量不匹配 | 返回数 ≠ 请求数 | 降级处理 | 使用原始脚本 | `batch-generate-narrations.ts:249-284` |

### 字段验证错误

| 错误 | 触发条件 | 处理程序 | 可修复 | 代码位置 |
|------|---------|---------|--------|---------|
| 必填字段缺失 | `scene_id`/时间戳为空 | ❌ 无 | ❌ | `validators/field-validator.ts` |
| 时间戳格式异常 | `00:06:500` 等 | `smartNormalize()` | ✅ | `timestamp-normalizer.ts:26-100` |
| 时间戳顺序错误 | `end < start` | `fixDurationSeconds()` | ✅ | `fixers/duration-fixer.ts:31-38` |
| 时长计算误差 | 差异 > 0.1s | `fixDurationSeconds()` | ✅ | `fixers/duration-fixer.ts:40-56` |
| 时间戳超范围 | 超出视频时长 | `validateTimestampRange()` | ✅ (跳过) | `validators/timestamp-validator.ts:55-67` |

---

## 处理程序详解

### repairTruncatedJson() - 截断修复

**文件**: `lib/ai/gemini/parsers/json-extractor.ts:58-96`

**触发条件**: `finishReason=MAX_TOKENS` 导致 JSON 不完整

**修复算法**:
1. 统计括号深度（`{` vs `}`, `[` vs `]`）
2. 找到最后一个完整元素位置
3. 截断后补全缺失括号（先 `]` 后 `}`）

**示例**:
```
输入: {"storyboards":[{"id":"1"},{"id":"2
输出: {"storyboards":[{"id":"1"}]}
```

---

### sanitizeJson() - JSON 清理

**文件**: `lib/ai/gemini/parsers/json-extractor.ts:164-211`

**7 项修复规则**:

| # | 问题 | 修复正则 |
|---|------|---------|
| 1 | 尾逗号 | `/,\s*([}\]])/g` → `$1` |
| 2 | 重复逗号 | `/,\s*,/g` → `,` |
| 3 | 对象间缺逗号 | `/([}\]])\s*\n\s*(["{[])/g` → `$1,\n$2` |
| 4 | 行内缺逗号 | `/([}\]])(\s+)(["{[])/g` → `$1,$2$3` |
| 5 | 字符串间缺逗号 | `/"(\s+)"(\w)/g` → `",$1"$2` |
| 6 | 未闭合字符串 | 引号数奇偶检查 → 补充 `"` |
| 7 | 控制字符 | `/[\x00-\x1F\x7F]/g` → 移除 |

---

### repairJsonWithAI() - AI 修复

**文件**: `lib/ai/gemini/parsers/json-repair.ts:42-101`

**触发条件**: `sanitizeJson()` 规则修复失败

**修复流程**:
1. 构建修复 Prompt（含损坏 JSON + Schema）
2. 调用 Gemini 2.5 Pro（JSON 模式）
3. 解析返回的修复后 JSON

**Schema 定义** (`json-repair.ts:144-158`):
```typescript
export const BATCH_NARRATION_SCHEMA = {
  type: 'object',
  properties: {
    scenes: {
      type: 'array',
      items: {
        properties: {
          scene_id: { type: 'string' },
          narration_v1: { type: 'string' },
          narration_v2: { type: 'string' },
          narration_v3: { type: 'string' },
        },
        required: ['scene_id', 'narration_v1', 'narration_v2', 'narration_v3'],
      },
    },
  },
  required: ['scenes'],
}
```

---

### smartNormalize() - 时间戳标准化

**文件**: `lib/utils/timestamp-normalizer.ts:26-100`

**支持格式（8种）**:

| 输入格式 | 示例 | 转换结果 |
|---------|------|---------|
| HH:MM:SS.mmm | `01:30:45.500` | `01:30:45.500` |
| HH:MM:SS | `01:30:45` | `01:30:45.000` |
| MM:SS.mmm | `30:45.500` | `00:30:45.500` |
| MM:SS | `30:45` | `00:30:45.000` |
| **MM:SS:mmm** ⚠️ | `00:06:500` | `00:00:06.500` |
| SS.mmm | `45.500` | `00:00:45.500` |
| 纯秒数 | `90.5` | `00:01:30.500` |
| 欧洲格式 | `01:30,500` | `00:01:30.500` |

**关键逻辑** (Gemini 常见错误修复):
```typescript
// 00:06:500 → 实际是 6.5 秒，不是 6分500秒
if (segments[2] >= 60 || thirdPartRaw.length === 3) {
  // MM:SS:mmm 格式（第三段是毫秒）
  hours = 0
  minutes = segments[0]  // 0
  secs = segments[1]     // 6
  additionalMs = segments[2]  // 500
}
```

---

### fixDurationSeconds() - 时长修复

**文件**: `lib/workflow/steps/analysis/fixers/duration-fixer.ts`

**功能 1 - 时间戳顺序交换** (第 31-38 行):
```typescript
if (endSeconds < startSeconds) {
  const tempStart = scene.source_start_time
  scene.source_start_time = scene.source_end_time
  scene.source_end_time = tempStart
  swapped = true
}
```

**功能 2 - 时长误差修正** (第 40-56 行):
```typescript
const calculatedDuration = endSeconds - startSeconds
const diff = Math.abs(calculatedDuration - scene.duration_seconds)
if (diff > 0.1) {
  scene.duration_seconds = calculatedDuration
  fixed = true
}
```

---

## 双层重试架构（Gemini 调用）

**文件**: `lib/ai/gemini/core/generate.ts:176-245`

**超时配置**: `GEMINI_API_TIMEOUT_MS = 3,600,000ms` (1 小时) - 第 18 行

```typescript
// 外层：速率限制器处理 429 错误
return geminiRateLimiter.execute(
  async () => {
    // 内层：withRetry 处理其他可重试错误
    return withRetry(
      async () => {
        const response = await withTimeout(
          client.models.generateContent(...),
          GEMINI_API_TIMEOUT_MS,  // 3,600,000ms = 1 小时
        )
        // ...
      },
      {
        maxAttempts: 3,          // 重试 3 次
        delayMs: 1000,           // 初始延迟 1 秒
        backoff: 2,              // 2x 指数退避
        shouldRetry: isRetryableError,  // 429 由外层处理
      }
    )
  },
  {
    platform,                    // 'ai-studio' 或 'vertex'
    operation: `generateContent(${modelId})`,
  }
)
```

---

## 验证流程（分析阶段）

**文件**: `lib/workflow/steps/analysis/validate.ts:161-241`

```
┌─────────────────────────────────────────────────────────────┐
│ 阶段 1：字段完整性验证                                        │
│ validateRequiredFields() → 致命错误或标记跳过                 │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 阶段 2：时间戳标准化                                          │
│ normalizeSceneTimestamps() → 自动转换格式                    │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 阶段 3：时长修复                                              │
│ fixDurationSeconds() → 自动交换 + 重新计算                   │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 阶段 4：范围验证                                              │
│ validateTimestampRange() → 超范围标记跳过                    │
└─────────────────────────────┬───────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 阶段 5：结果汇总                                              │
│ 有效分镜 / 跳过分镜 / 致命错误                                │
└─────────────────────────────────────────────────────────────┘
```

---

## 处理程序速查表

| 处理程序 | 文件 | 行号 | 处理的错误 | 重试策略 |
|---------|------|------|-----------|---------|
| `withRetry()` | `lib/utils/retry.ts` | 3-47 | 网络/超时/5xx | 3次, 1→2→4秒 |
| `isRetryableError()` | `lib/utils/retry.ts` | 55-123 | 判断可重试性 | - |
| `geminiRateLimiter` | `lib/ai/gemini/core/rate-limiter.ts` | 87-196 | 429 限流 | AI Studio: 60次/10-60秒, Vertex: 4次/8-45秒 |
| `is429Error()` | `lib/ai/gemini/core/rate-limiter.ts` | 50-65 | 429 检测 | - |
| `downloadWithResume()` | `lib/media/utils/download.ts` | 52-121 | 下载失败 | 20次, 60秒固定 |
| `repairTruncatedJson()` | `lib/ai/gemini/parsers/json-extractor.ts` | 58-96 | JSON 截断 | 自动修复 |
| `sanitizeJson()` | `lib/ai/gemini/parsers/json-extractor.ts` | 164-211 | JSON 语法 | 自动修复 |
| `repairJsonWithAI()` | `lib/ai/gemini/parsers/json-repair.ts` | 42-101 | 复杂 JSON | AI 修复 |
| `BatchFormatError` | `lib/ai/gemini/index.ts` | 41-50 | 格式字段错误 | 2次, 2秒固定 |
| `smartNormalize()` | `lib/utils/timestamp-normalizer.ts` | 26-100 | 时间戳格式 | 自动转换 |
| `fixDurationSeconds()` | `lib/workflow/steps/analysis/fixers/duration-fixer.ts` | 31-56 | 时长/顺序 | 自动修复 |
| `validateTimestampRange()` | `lib/workflow/steps/analysis/validators/timestamp-validator.ts` | 55-67 | 超范围 | 标记跳过 |
| `validateRequiredFields()` | `lib/workflow/steps/analysis/validators/field-validator.ts` | - | 必填缺失 | 致命错误 |

---

## 覆盖统计

| 类别 | 有处理程序 | 无处理程序 |
|------|-----------|-----------|
| 网络层错误 | ✅ 全覆盖 | - |
| 429 限流 | ✅ 全覆盖 | - |
| 输出内容错误 | ✅ MAX_TOKENS | ❌ 空响应/SAFETY/RECITATION |
| JSON 格式错误 | ✅ 全覆盖 | - |
| 业务格式错误 | ✅ 全覆盖 | - |
| 字段验证错误 | ✅ 大部分 | ❌ 必填字段缺失 |

---

## 相关文件索引

```
lib/utils/retry.ts                                    # 通用重试
lib/ai/gemini/core/rate-limiter.ts                    # 429 专用
lib/ai/gemini/core/generate.ts                        # 双层重试集成
lib/ai/gemini/index.ts                                # BatchFormatError
lib/ai/gemini/parsers/json-extractor.ts               # JSON 提取/清理/截断修复
lib/ai/gemini/parsers/json-repair.ts                  # AI 修复 JSON
lib/utils/timestamp-normalizer.ts                     # 时间戳标准化
lib/utils/error-classifier.ts                         # 错误分类器
lib/workflow/steps/analysis/validate.ts               # 验证流程编排
lib/workflow/steps/analysis/validators/*.ts           # 字段/时间戳/数量验证
lib/workflow/steps/analysis/fixers/*.ts               # 时长/时间戳修复
lib/workflow/steps/narration/batch-generate-narrations.ts  # 数量不匹配处理
lib/media/utils/download.ts                           # 视频下载重试
```
